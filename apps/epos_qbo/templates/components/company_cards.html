{% for company_data in companies_data %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm mb-4 overflow-hidden hover:shadow-md transition-shadow" x-data="{ expanded: false }">
    <div class="p-6 cursor-pointer hover:bg-slate-50 transition-colors" @click="expanded = !expanded">
        <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-lg font-semibold text-slate-900 truncate">{{ company_data.company.display_name }}</h3>
                    <span class="px-2 py-1 bg-{{ company_data.status.color }}-100 text-{{ company_data.status.color }}-700 text-xs font-medium rounded-full flex items-center gap-1.5 flex-shrink-0">
                        <span class="w-2 h-2 bg-{{ company_data.status.color }}-500 rounded-full"></span>
                        {{ company_data.status.label }}
                    </span>
                </div>
                <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600">
                    <span class="flex items-center gap-1.5">
                        <iconify-icon icon="solar:clock-circle-linear" width="16" class="text-slate-400"></iconify-icon>
                        {{ company_data.last_run_display }}
                    </span>
                    <span class="flex items-center gap-1.5">
                        <iconify-icon icon="solar:document-linear" width="16" class="text-slate-400"></iconify-icon>
                        {{ company_data.records_24h|default:"0" }} records (24h)
                    </span>
                    <span class="flex items-center gap-1.5">
                        <iconify-icon icon="solar:key-minimalistic-linear" width="16" class="text-slate-400"></iconify-icon>
                        Token: <span class="{% if company_data.token_info.severity == 'critical' %}text-red-600{% elif company_data.token_info.severity == 'warning' %}text-amber-600{% else %}text-emerald-600{% endif %}">{{ company_data.token_info.display_label }}</span>
                    </span>
                </div>
                {% if company_data.issues %}
                <div class="mt-3 flex items-center gap-2 text-sm">
                    <iconify-icon icon="solar:danger-triangle-linear" width="16" class="text-{{ company_data.status.color }}-500 flex-shrink-0"></iconify-icon>
                    <span class="text-{{ company_data.status.color }}-700 font-medium">{{ company_data.issues|length }} issue{{ company_data.issues|length|pluralize }}</span>
                </div>
                {% endif %}
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
                {% if perms.epos_qbo.can_trigger_runs %}
                <form method="post" action="{% url 'epos_qbo:run-trigger' %}" class="inline" @click.stop>
                    {% csrf_token %}
                    <input type="hidden" name="scope" value="single_company">
                    <input type="hidden" name="company_key" value="{{ company_data.company.company_key }}">
                    <input type="hidden" name="date_mode" value="yesterday">
                    <button type="submit" class="btn-icon group" title="Trigger sync">
                        <iconify-icon icon="solar:play-circle-linear" width="20" class="text-slate-400 group-hover:text-blue-600"></iconify-icon>
                    </button>
                </form>
                {% endif %}
                <iconify-icon :icon="expanded ? 'solar:alt-arrow-up-linear' : 'solar:alt-arrow-down-linear'" width="20" class="text-slate-400"></iconify-icon>
            </div>
        </div>
    </div>

    <div x-show="expanded" x-transition class="border-t border-slate-100">
        {% if company_data.issues %}
        <div class="p-6 bg-slate-50">
            <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                <iconify-icon icon="solar:danger-triangle-linear" width="16"></iconify-icon>
                Active Issues
            </h4>
            <div class="space-y-2">
                {% for issue in company_data.issues %}
                <div class="flex items-start gap-2 p-3 bg-white rounded-lg border border-{{ issue.severity }}-200">
                    <iconify-icon icon="{{ issue.icon }}" class="text-{{ issue.severity }}-500 mt-0.5 flex-shrink-0" width="16"></iconify-icon>
                    <div class="flex-1 min-w-0"><p class="text-sm text-slate-700">{{ issue.message }}</p></div>
                    {% if issue.action == 'view_run' and company_data.latest_run %}
                    <a href="{% url 'epos_qbo:run-detail' job_id=company_data.latest_run.id %}" class="text-xs text-blue-600 hover:text-blue-700 font-medium whitespace-nowrap">View →</a>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="p-6 {% if not company_data.issues %}bg-slate-50{% endif %}">
            <h4 class="text-sm font-semibold text-slate-700 mb-4 flex items-center gap-2">
                <iconify-icon icon="solar:settings-linear" width="16"></iconify-icon>
                Configuration
            </h4>
            <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-slate-500">Inventory:</span>
                    <span class="text-slate-900 font-medium">
                        {% if company_data.config_display.inventory_enabled %}<span class="flex items-center gap-1.5 text-emerald-600"><iconify-icon icon="solar:check-circle-linear" width="14"></iconify-icon>Enabled</span>{% else %}<span class="text-slate-400">Disabled</span>{% endif %}
                    </span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-500">Tax rate:</span>
                    <span class="text-slate-900 font-medium">{{ company_data.config_display.tax_rate|default:"—" }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-500">Schedule:</span>
                    <span class="text-slate-900 font-medium">{{ company_data.config_display.schedule }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-slate-500">Deposit Account:</span>
                    <span class="text-slate-900 font-medium truncate ml-2" title="{{ company_data.config_display.deposit_account }}">{{ company_data.config_display.deposit_account|truncatechars:20 }}</span>
                </div>
                <div class="flex items-center justify-between col-span-2">
                    <span class="text-slate-500">QBO Realm ID:</span>
                    <span class="text-slate-600 font-mono text-xs">{{ company_data.config_display.realm_id }}</span>
                </div>
            </div>
        </div>

        {% if company_data.latest_run %}
        <div class="p-6 border-t border-slate-100">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                    <iconify-icon icon="solar:history-linear" width="16"></iconify-icon>
                    Latest Run
                </h4>
                <a href="{% url 'epos_qbo:runs' %}?company={{ company_data.company.company_key }}" class="text-xs text-blue-600 hover:text-blue-700 font-medium">View All Runs →</a>
            </div>
            <div class="bg-slate-50 rounded-lg p-3 text-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-slate-600">Run #{{ company_data.latest_run.id|slice:":8" }}</span>
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium
                        {% if company_data.latest_run.status == 'succeeded' %}bg-emerald-100 text-emerald-700
                        {% elif company_data.latest_run.status == 'failed' %}bg-red-100 text-red-700
                        {% elif company_data.latest_run.status == 'running' %}bg-blue-100 text-blue-700
                        {% else %}bg-slate-100 text-slate-700{% endif %}">
                        {{ company_data.latest_run.get_status_display }}
                    </span>
                </div>
                <div class="text-xs text-slate-500">
                    {{ company_data.latest_run.started_at|date:"M d, Y g:i A" }}
                    {% if company_data.latest_run.target_date %} • Target: {{ company_data.latest_run.target_date|date:"Y-m-d" }}{% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="p-6 bg-slate-50 border-t border-slate-100 flex flex-wrap items-center gap-3">
            <a href="{% url 'epos_qbo:company-detail' company_data.company.company_key %}" class="btn btn-secondary">
                <iconify-icon icon="solar:eye-linear" width="16"></iconify-icon>
                View Details
            </a>
            {% if perms.epos_qbo.can_trigger_runs %}
            <form method="post" action="{% url 'epos_qbo:run-trigger' %}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="scope" value="single_company">
                <input type="hidden" name="company_key" value="{{ company_data.company.company_key }}">
                <input type="hidden" name="date_mode" value="yesterday">
                <button type="submit" class="btn btn-primary">
                    <iconify-icon icon="solar:play-circle-linear" width="16"></iconify-icon>
                    Trigger Sync
                </button>
            </form>
            {% endif %}
            {% if company_data.token_info.expiring_soon %}
            <span class="px-4 py-2 bg-amber-100 text-amber-800 rounded-lg text-sm font-medium flex items-center gap-2">
                <iconify-icon icon="solar:refresh-linear" width="16"></iconify-icon>
                Token expiring soon
            </span>
            {% endif %}
            {% if perms.epos_qbo.can_edit_companies %}
            <a href="{% url 'epos_qbo:company-advanced' company_data.company.company_key %}" class="btn btn-secondary">
                <iconify-icon icon="solar:settings-linear" width="16"></iconify-icon>
                Edit Config
            </a>
            <div class="ml-auto relative" x-data="{ open: false }">
                <button type="button" @click="open = !open" class="btn-icon border border-transparent hover:border-slate-200">
                    <iconify-icon icon="solar:menu-dots-linear" width="20" class="text-slate-600"></iconify-icon>
                </button>
                <div x-show="open" @click.outside="open = false" x-transition class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-10">
                    <form method="post" action="{% url 'epos_qbo:company-sync-json' company_data.company.company_key %}" class="block">
                        {% csrf_token %}
                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Force Sync to JSON</button>
                    </form>
                    <form method="post" action="{% url 'epos_qbo:company-toggle-active' company_data.company.company_key %}" class="block">
                        {% csrf_token %}
                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">{{ company_data.company.is_active|yesno:"Deactivate,Activate" }} Company</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}
